<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="None">
  <meta name="author" content="Mark Mazumder">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018) - Parrot Mambo Notes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="css/theme.css" type="text/css" />
  <link rel="stylesheet" href="css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018)";
    var mkdocs_page_input_path = "index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> Parrot Mambo Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1 current">
		
    <a class="current" href=".">Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018)</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#parrot-mambo-notes-mit-16301631-fall-2018">Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018)</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#overview">Overview</a></li>
        
            <li><a class="toctree-l3" href="#installing-gstreamer">Installing GStreamer</a></li>
        
            <li><a class="toctree-l3" href="#wifi-access-to-the-mambo">WiFi access to the Mambo</a></li>
        
            <li><a class="toctree-l3" href="#viewing-the-front-camera-with-gstreamer">Viewing the front camera  with GStreamer</a></li>
        
            <li><a class="toctree-l3" href="#installing-opencv">Installing OpenCV</a></li>
        
            <li><a class="toctree-l3" href="#python-camera-stream-access">Python camera stream access</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">Parrot Mambo Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018)</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="parrot-mambo-notes-mit-16301631-fall-2018">Parrot Mambo Notes (MIT 16.30/16.31, Fall 2018)</h1>
<p>The following notes may be helpful for connecting to the front and/or downward camera for initial experimentation and projects.</p>
<div class="admonition warning">
<p class="admonition-title">This documentation is in-progress!</p>
<p><em>Do you have tips, resources, or corrections to add? Did you find something frustrating or unhelpful and want to remove it? Notice any typos?</em>  <a href="https://github.com/mmaz/mambo_notes/blob/master/docs/index.md">This documentation page can be edited on GitHub!</a> (Also, feel free to <a href="https://github.com/mmaz/mambo_notes/issues">post an issue</a>).</p>
</div>
<h2 id="overview">Overview</h2>
<p>The Mambo can support two cameras: </p>
<ul>
<li>a downward-facing camera and, </li>
<li>(optionally) a front-facing camera, via the FPV accessory which snaps on top of the drone.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Simultaneoulsy streaming both cameras is still <strong>untested</strong> - please <a href="https://github.com/mmaz/mambo_notes/issues">make note</a> if you test this!</p>
</div>
<p>There are a few options available for camera access. (This is a non-exhaustive list!)</p>
<ol>
<li>The downward camera is currently available in Matlab (see Piazza for details, link to be added)</li>
<li>Options for directly accessing the front camera stream in Matlab are being explored (more information to come...)</li>
<li>The Python library <a href="https://pyparrot.readthedocs.io/en/latest/"><code>pyparrot</code></a> has <a href="https://pyparrot.readthedocs.io/en/latest/quickstartminidrone.html#demo-of-the-ground-facing-camera">documentation on accessing the downward camera</a>. Note the docs state that this is only available in wifi-mode (not bluetooth-mode).</li>
<li>PyParrot also has a front camera example <a href="https://github.com/amymcgovern/pyparrot/blob/master/examples/demoMamboVisionGUI.py">here</a></li>
<li><a href="https://gstreamer.freedesktop.org/documentation/">GStreamer</a>, a Linux command-line-tool, supports front-camera access (including from within python)</li>
</ol>
<p>I (Mark) have been using GStreamer from within Python, which the documentation below will explain in some more detail.</p>
<p>For projects using the cameras, I highly recommend starting with a few representative data-collects. For instance, if you wanted to track a person, begin by recording some videos from the drone's camera. For instance, record some videos of one person in frame, multiple people in frame, and videos without people. Record videos with the drone flying or with the drone hand-carried. You can use GStreamer for all these collects. Then, these files can be used for exploration and testing without needing to rely on the short battery life of the drone.</p>
<h2 id="installing-gstreamer">Installing GStreamer</h2>
<p>To install GStreamer on Linux, you can follow <a href="https://gstreamer.freedesktop.org/documentation/installing/on-linux.html">the instructions in their documentation</a>. On Ubuntu, I used this command (taken from the above documentation):</p>
<pre><code class="shell">$ sudo apt-get install libgstreamer1.0-0 gstreamer1.0-plugins-base \ 
   gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \ 
   gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-doc gstreamer1.0-tools
</code></pre>

<h2 id="wifi-access-to-the-mambo">WiFi access to the Mambo</h2>
<p>To connect via GStreamer you will need to connect to your drone over WiFi. Power on your drone with the camera attachment connected, and then look for the WiFi network which is created by the drone. </p>
<div class="admonition danger">
<p class="admonition-title">Caveat</p>
<p>WiFi connections to the drone are flaky in my experience. This connection process takes multiple tries on my drone (within 4-5 tries usually, but up to 10). I usually pull the battery out and re-insert for each try. </p>
</div>
<p>The network SSID will be called, e.g., <code>Mambo_12345</code>, with an ID# corresponding to your drone. Once you are connected, you can use gstreamer to test streaming an image to your computer (on the command line, without python) or connect to the stream within python.</p>
<div class="admonition warning">
<p class="admonition-title">re-connecting not supported?</p>
<p>I usually have to restart the drone in between camera stream connections, i.e., I can't test the connection with gstreamer on the command line, and then start a processing script in python.</p>
</div>
<h2 id="viewing-the-front-camera-with-gstreamer">Viewing the front camera  with GStreamer</h2>
<p>After you have installed gstreamer and connected to your drone's wifi access point, you should be able to use the following command which opens a new window on your laptop to view the drone's camera feed:</p>
<pre><code class="bash">gst-launch-1.0 rtspsrc location=rtsp://192.168.99.1/media/stream2 latency=10 ! decodebin ! autovideosink
</code></pre>

<p><code>latency=10</code> is a <a href="https://gstreamer.freedesktop.org/documentation/design/latency.html">tuneable parameter</a>, to control the amount of buffering.</p>
<p><code>Ctrl-C</code> at the terminal should end the stream.</p>
<p>Once this works, you can also test recording a video from the front camera feed. You will probably need to power-cycle the drone first (pull the battery out and place it back in)</p>
<p>Note: you'll need to add a <code>-e</code> flag (end of stream) before <code>rtspsrc</code> so that the <code>.mp4</code> video file will be correctly closed when you <code>ctrl-c</code> the stream. See <a href="https://stackoverflow.com/a/25949095">this link</a> for more details if interested.</p>
<pre><code class="bash">gst-launch-1.0 -e rtspsrc location=rtsp://192.168.99.1/media/stream2 latency=10 ! decodebin ! x264enc ! mp4mux ! filesink location=file1.mp4
</code></pre>

<p>You can specify your preferred filename at the end of the above command (e.g., <code>file1</code>).</p>
<h2 id="installing-opencv">Installing OpenCV</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is optional - if you just want to test with GStreamer, for instance, to record a video from the front camera, you don't need to use OpenCV.</p>
</div>
<p>OpenCV will allow you to access the front camera stream programmatically (e.g., via python or c++).</p>
<p>However (as far as I know), most prepackaged versions of OpenCV (e.g., the one you'll find via <code>apt-get</code>, <code>pip</code>, or <code>conda</code>) do not come with internal support for GStreamer. You'll have to download and compile OpenCV with support for GStreamer yourself.</p>
<p>First, you'll need development packages for gstreamer to compile opencv against (the interested reader can see <a href="https://stackoverflow.com/questions/37678324/compiling-opencv-with-gstreamer-cmake-not-finding-gstreamer">this stackoverflow question</a> for details), but essentially: </p>
<pre><code class="bash">$ apt-get install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
</code></pre>

<p>Now you'll need a bunch of dependencies for building OpenCV from source:</p>
<pre><code class="bash">$ sudo apt-get install build-essential cmake pkg-config \
      libjpeg-dev libtiff5-dev libjasper-dev libpng12-dev \
      libavcodec-dev libavformat-dev libswscale-dev  \
      libv4l-dev libxvidcore-dev libx264-dev \
      libgtk2.0-dev libgtk-3-dev \
      libatlas-base-dev gfortran \
      python2.7-dev python3-dev
</code></pre>

<p>I will place OpenCV in the home directory (but you can move it elsewhere)</p>
<pre><code class="bash">cd ~ #move to home directory
</code></pre>

<p>The following command should download, build, and install OpenCV 3.3.0:</p>
<pre><code class="bash">wget -O opencv.zip https://github.com/Itseez/opencv/archive/3.3.0.zip
unzip opencv.zip
wget -O opencv_contrib.zip https://github.com/Itseez/opencv_contrib/archive/3.3.0.zip
unzip opencv_contrib.zip
cd ~/opencv-3.3.0/
mkdir build
cd build
cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      -D INSTALL_PYTHON_EXAMPLES=OFF \
      -D WITH_V4L=ON \
      -D WITH_GSTREAMER=ON \
      -D BUILD_opencv_cnn_3dobj=OFF \
      -D BUILD_opencv_dnn_modern=OFF \
      -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib-3.3.0/modules \
      -D BUILD_EXAMPLES=OFF ..
make -j4
sudo make install
sudo ldconfig
</code></pre>

<p>The relevant option from the above build and install is <code>-D WITH_GSTREAMER=ON</code>, which is not a default flag for OpenCV.</p>
<h2 id="python-camera-stream-access">Python camera stream access</h2>
<p>Now you should be able to access the drone's stream from within Python. (Re)start the drone and connect to the access point over WiFi. Then run this script:</p>
<pre><code class="python">import cv2
cv2.namedWindow(&quot;frame&quot;, cv2.WINDOW_NORMAL)
gst = &quot;rtspsrc location=rtsp://192.168.99.1/media/stream2 latency=10 ! rtph264depay ! h264parse ! avdec_h264 ! videoconvert ! appsink&quot;
cap = cv2.VideoCapture(gst)
while(cap.isOpened()):
    ret, frame = cap.read()
    # you can add your processing here on the frame
    cv2.imshow('frame',frame)
    if cv2.waitKey(1) &amp; 0xFF == ord('q'):
        break
cap.release()
cv2.destroyAllWindows()
</code></pre>

<p>Pressing <code>q</code> will close the window.</p>
<p><strong>Troubleshooting:</strong> If the above code doesn't work, you can stream in a 'test' video from gstreamer to verify that python is importing the <em>correct</em> version of OpenCV (i.e., the one you compiled to support GStreamer). First, inspect OpenCV's build information:</p>
<pre><code class="python">from __future__ import print_function
import cv2
print(cv2.getBuildInformation())
</code></pre>

<p>Make sure you see the line <code>GStreamer: YES</code> in the output.</p>
<p>Next, use the <code>videotestsrc</code> to make sure Python can display a gstreamer video source using OpenCV:</p>
<pre><code>import cv2
cv2.namedWindow(&quot;frame&quot;, cv2.WINDOW_NORMAL)
gst = &quot;videotestsrc ! appsink&quot;
cap = cv2.VideoCapture(gst)
while(cap.isOpened()):
    ret, frame = cap.read()
    cv2.imshow('frame',frame)
    if cv2.waitKey(1) &amp; 0xFF == ord('q'):
        break
cap.release()
cv2.destroyAllWindows()
</code></pre>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>2018 Mark Mazumder</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>

</body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2018-11-07 01:38:23
-->
